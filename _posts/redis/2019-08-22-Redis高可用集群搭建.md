---
layout: post
title: "Redis高可用集群搭建"
date: 2019-08-22 19:12:48
description: "Redis高可用集群搭建"
categories:
- Redis
permalink: Redis高可用集群搭建
---

###### 1. 下载redis安装包放在`/usr/local`目录下

```vim
wget http://download.redis.io/releases/redis-5.0.2.tar.gz

tar xzf redis-5.0.2.tar.gz

cd redis-5.0.2
```

###### 2. 编译与安装

```vim
make & make install
```

###### 3. 启动

```vim
src/redis-server redis.conf
```

###### 4. 关闭

```vim
pkill redis-server

src/redis-cli shutdown
```

##### 开始集群搭建

###### 1. 修改redis.conf配置文件

```vim
1）daemonize yes
2）port 8001（分别对每个机器的端口号进行设置）
3）dir /usr/local/redis-cluster/8001/（指定数据文件存放位置，必须要指定不同的目录位置，不然会丢失数据
4）cluster-enabled yes（启动集群模式）
5）cluster-config-file nodes-8001.conf（集群节点信息文件，这里800x最好和port对应上）
6）cluster-node-timeout 5000
7) bind 127.0.0.1（去掉bind绑定访问ip信息）
8) protected-mode  no   （关闭保护模式）
9）appendonly yes
如果要设置密码需要增加如下配置：
10）requirepass xxx     (设置redis访问密码)
11）masterauth  xxx     (设置集群节点间访问密码，跟上面一致)
```

###### 2. 启动redis实例

```vim
/usr/local/redis/redis-5.0.2/src/redis-server /usr/local/redis-cluster/700*/redis.conf
```

###### 3. 使用redis-cli创建redis集群

```vim
/usr/local/redis-5.0.4/src/redis-cli --cluster create --cluster-replicas 1 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006
```

```vim
>>> Performing hash slots allocation on 6 nodes...
Master[0] -> Slots 0 - 5460
Master[1] -> Slots 5461 - 10922
Master[2] -> Slots 10923 - 16383
Adding replica 127.0.0.1:7005 to 127.0.0.1:7001
Adding replica 127.0.0.1:7006 to 127.0.0.1:7002
Adding replica 127.0.0.1:7004 to 127.0.0.1:7003
>>> Trying to optimize slaves allocation for anti-affinity
[WARNING] Some slaves are in the same host as their master
M: 4626e1b0cd356df4fe365181e309cda72c371499 127.0.0.1:7001
   slots:[0-5460] (5461 slots) master
M: 7655270c80c35a0c1d7e2dce7cec52b12664cfc6 127.0.0.1:7002
   slots:[5461-10922] (5462 slots) master
M: 27720a39099c3b219e57173527205bdea431d531 127.0.0.1:7003
   slots:[10923-16383] (5461 slots) master
S: 420ca6b67bbe4db60630bc20fd2f2a0c12955fe0 127.0.0.1:7004
   replicates 7655270c80c35a0c1d7e2dce7cec52b12664cfc6
S: d5f4a2122fc632f9b10c4074b662c4b6653eabf2 127.0.0.1:7005
   replicates 27720a39099c3b219e57173527205bdea431d531
S: 58f7091ebdbed34d829cd9547da43dcc85e96d32 127.0.0.1:7006
   replicates 4626e1b0cd356df4fe365181e309cda72c371499
Can I set the above configuration? (type 'yes' to accept): yes
>>> Nodes configuration updated
>>> Assign a different config epoch to each node
>>> Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
...
>>> Performing Cluster Check (using node 127.0.0.1:7001)
M: 4626e1b0cd356df4fe365181e309cda72c371499 127.0.0.1:7001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: 420ca6b67bbe4db60630bc20fd2f2a0c12955fe0 127.0.0.1:7004
   slots: (0 slots) slave
   replicates 7655270c80c35a0c1d7e2dce7cec52b12664cfc6
S: 58f7091ebdbed34d829cd9547da43dcc85e96d32 127.0.0.1:7006
   slots: (0 slots) slave
   replicates 4626e1b0cd356df4fe365181e309cda72c371499
M: 7655270c80c35a0c1d7e2dce7cec52b12664cfc6 127.0.0.1:7002
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: d5f4a2122fc632f9b10c4074b662c4b6653eabf2 127.0.0.1:7005
   slots: (0 slots) slave
   replicates 27720a39099c3b219e57173527205bdea431d531
M: 27720a39099c3b219e57173527205bdea431d531 127.0.0.1:7003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

##### 常见问题
- `[ERR] Node 127.0.0.1:7001 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0.`

```vim
删除每个节点下aof、rdb、nodes.conf本地备份文件
```

- `(error) MOVED 12706 127.0.0.1:7003`

```vim
/usr/local/redis-5.0.4/src/redis-cli -c -h 127.0.0.1 -p 7003
`-c表示启用集群模式`
```

##### 参考资料
- [https://www.jianshu.com/p/8045b92fafb2](https://www.jianshu.com/p/8045b92fafb2)
