---
layout: post
title: "InnoDB存储引擎中的锁"
date: 2018-05-18 15:35:30
description: "InnoDB存储引擎中的锁"
categories:
- MySQL
permalink: InnoDB存储引擎中的锁
---

##### 锁的类型

InnoDB存储引擎实现了如下两种标准的行级锁  

* 共享锁（S Lock），允许事务读一行数据。
* 排他锁（X Lock），允许事务删除或者更新一行数据。

InnoDB存储引擎支持多粒度锁定，这种锁定允许在行级上的锁和表级上的锁同时存在。  
为了支持在不同粒度上进行加锁操作，InnoDB存储引擎支持一种额外的锁方式，我们称之为`意向锁`。  
意向锁是表级别的锁，InnoDB存储引擎支持两种意向锁  

* 意向共享锁（IS Lock），事务想要获得一个表中某几行的共享锁。
* 意向排他锁（IX Lock），事务想要获得一个表中某几行的排他锁。

##### 锁的算法

InnoDB存储引擎有3种行锁的算法设计  

* Record Lock：单个行记录上的锁
> Record Lock总是会去锁住索引记录。如果InnoDB存储引擎表建立的时候没有设置任何一个索引，  
> 这时InnoDB存储引擎会使用隐式的主键来进行锁定

* Gap Lock：间隙锁，锁定一个范围，但不包含记录本身
* Next-Key Lock：Gap Lock + Record Lock，锁定一个范围，并且锁定记录本身

![](/assets/img/Next-Key Lock.png)

##### 多版本并发控制（MVCC）

MVCC在大多数情况下代替了行锁，实现了对读的非阻塞，读不加锁，读写不冲突。  
缺点是每行记录都需要额外的存储空间，需要做更多的行维护和检查工作。  

###### InnoDB存储引擎中的隐藏列

|列名|长度（字节）|作用|
|:--:|:--|:--|
|DB_TRX_ID|6|插入或更新行的最后一个事务的事务标识符。（删除视为更新，将其标记为已删除）|
|DB_ROLL_PTR|7|写入回滚段的撤消日志记录（若行已更新，则撤消日志记录包含在更新行之前重建行内容所需的信息）|
|DB_ROW_ID|6|行标识（隐藏单调自增id）|
